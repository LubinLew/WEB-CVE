FROM lubinlew/jdk:8u261

MAINTAINER lubinlew "https://github.com/LubinLew"

## install supervisord
RUN  yum install -y epel-release supervisor
RUN  yum install -y supervisor
RUN  yum clean all
COPY reproducer/supervisord.conf /etc/supervisord.conf

## install POC
RUN  mkdir -p /opt/server/META-INF/services/
RUN  echo "PoC" > /opt/server/META-INF/services/javax.script.ScriptEngineFactory
COPY reproducer/PoC.java /opt/server
RUN  cd /opt/server && javac PoC.java
COPY reproducer/python-server.sh   /opt/server

## install zookeeper
#RUN curl -o /tmp/zookeeper.tar.gz https://apache.claz.org/zookeeper/zookeeper-3.6.2/apache-zookeeper-3.6.2-bin.tar.gz
COPY reproducer/apache-zookeeper-3.6.2-bin.tar.gz /tmp/zookeeper.tar.gz
RUN  tar xf /tmp/zookeeper.tar.gz -C /opt/
RUN  mv /opt/apache-zookeeper-3.6.2-bin /opt/zookeeper
RUN  rm -f /tmp/zookeeper.tar.gz
RUN  mv /opt/zookeeper/conf/zoo_sample.cfg /opt/zookeeper/conf/zoo.cfg
COPY reproducer/zookeeper.sh /opt/zookeeper/

## install shardingsphere 4.0
COPY reproducer/apache-shardingsphere-incubating-4.0.0-sharding-ui-bin.tar.gz /tmp/shardingsphere.tar.gz
#RUN  curl -o /tmp/shardingsphere.tar.gz https://archive.apache.org/dist/incubator/shardingsphere/4.0.0/apache-shardingsphere-incubating-4.0.0-sharding-ui-bin.tar.gz
RUN  tar xf /tmp/shardingsphere.tar.gz -C /opt/
RUN  rm -f /tmp/shardingsphere.tar.gz
RUN  mv /opt/apache-shardingsphere-incubating-4.0.0-sharding-ui-bin /opt/shardingsphere
COPY reproducer/shardingsphere.sh /opt/shardingsphere
RUN  echo "tail -f /opt/shardingsphere/logs/stdout.log" >> /opt/shardingsphere/bin/start.sh

## install ldap
RUN  mkdir -p /opt/ldap
COPY reproducer/marshalsec-0.0.3-SNAPSHOT-all.jar /opt/ldap/
#RUN  curl -o /opt/ldap/marshalsec-0.0.3-SNAPSHOT-all.jar https://raw.githubusercontent.com/RandomRobbieBF/marshalsec-jar/master/marshalsec-0.0.3-SNAPSHOT-all.jar
COPY reproducer/ldap.sh /opt/ldap/

# 1389 : ldap
# 2181 :zookeeper
# 8000 : python-server
# 8088 : shardingsphere
EXPOSE 1389 2181 8000 8088


ENTRYPOINT ["/usr/bin/supervisord"]
